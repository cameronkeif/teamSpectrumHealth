@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div id="body">
    <div id="loadingAnimation">
        <img src="~/Images/loading.gif">
    </div>
    <div id="listContainer" >
        <div id="severeContainer" class="container">
            <span class="secondaryTitle">Severe</span>
            <ul id="severeWatchList" class="shortageList">
            </ul>
            <ul id="severeList" class="shortageList">
            </ul>
        </div>
        <div id="warningContainer" class="container">
            <span class="secondaryTitle">Warning</span>
            <ul id="warningWatchList" class="shortageList">
            </ul>
            <ul id="warningList" class="shortageList">
            </ul>
        </div>
        <div id="goodContainer" class="container">
            <span class="secondaryTitle">Good</span>
            <ul id="goodWatchList" class="shortageList">
            </ul>
            <ul id="goodList" class="shortageList">
            </ul>
        </div>
        <div id="recentContainer" class="container">
            <span class="secondaryTitle">Recent</span>
            <ul id="recentList" class="shortageList">
            </ul>
        </div>
    </div>
</div>

@section scripts{
<script type="text/javascript">
$('#listContainer').hide();
var loggedInAs = '@Html.Encode(ViewData["Username"])';
    var userType = '@Html.Encode(ViewData["Type"])'
var lastVisits = new Array();
var lastPosts = new Array();
$(function()
{
    var recent = new Array();
    var watchListNdcs = Array();

    // Populates list of visits for logged in user
    $.getJSON('/api/DrugVisit/' + loggedInAs, function (drugVisitJsonPayload) {
        $(drugVisitJsonPayload).each(function (i, visit) {
            lastVisits.push([visit.NDC, visit.Date]);
        });
    });

    // Populates list of last posts for each drug
    $.getJSON('/api/DrugEntry', function (drugJsonPayload) {
        $(drugJsonPayload).each(function (i, item) {
            if (item.LastPost != null) {
                lastPosts.push([item.NDC, item.LastPost]);
            }
        });

        $.getJSON('/api/WatchListItem/' + loggedInAs, function (watchListJsonPayload) {
            $(watchListJsonPayload).each(function (i, watchListItem) {
                watchListNdcs.push(watchListItem.Ndc);
            });
        });    

        // Get all drugs
        $.getJSON('/api/DrugEntry', function (drugJsonPayload) {
            $(drugJsonPayload).each(function (i, item) {

                recent.push(item);

                // This drug is in the user's watch list
                if ($.inArray(item.NDC, watchListNdcs) != -1) {
                    shortage = getShortageItemHTMLWatchList(item.Brand, item.Dosage, item.NDC, item.CurrentStatus);

                    if (item.CurrentStatus === "severe") {
                        $(shortage).appendTo('#severeWatchList').addClass("severeItem");
                    }
                    else if (item.CurrentStatus === "warning") {
                        $(shortage).appendTo('#warningWatchList').addClass("warningItem");
                    }
                    else {
                        $(shortage).appendTo('#goodWatchList').addClass("goodItem");
                    }
                }
                else {
                    shortage = getShortageItemHTML(item.Brand, item.Dosage, item.NDC, item.CurrentStatus);

                    if (item.CurrentStatus === "severe") {
                        $(shortage).appendTo('#severeList').addClass("severeItem");
                    }
                    else if (item.CurrentStatus === "warning") {
                        $(shortage).appendTo('#warningList').addClass("warningItem");
                    }
                    else {
                        $(shortage).appendTo('#goodList').addClass("goodItem");
                    }
                }
            });



            recent.sort(function (a, b) { if (a.LastUpdated < b.LastUpdated) return 1; return -1; });

            for (var i = 0; i < recent.length && i < 10; i++) {
                var item = recent[i];
                var shortage;

                if ($.inArray(item.NDC, watchListNdcs) != -1) {
                    shortage = getShortageItemHTMLWatchList(item.Brand, item.Dosage, item.NDC, item.CurrentStatus);
                }
                else {
                    shortage = getShortageItemHTML(item.Brand, item.Dosage, item.NDC, item.CurrentStatus);
                }

                if (item.CurrentStatus === "severe") {
                    $(shortage).appendTo('#recentList').addClass("severeItem");
                }
                else if (item.CurrentStatus === "warning") {
                    $(shortage).appendTo('#recentList').addClass("warningItem");
                }
                else {
                    $(shortage).appendTo('#recentList').addClass("goodItem");
                }
            }

            // Page has loaded. Stop the loading animation
            $('#loadingAnimation').hide();
            $('#listContainer').show();
        });

    });
});

function getNonWatchListShortageCardButtonHtml(ndc, currentStatus) {
    if (loggedInAs == "Guest") {
        return '';
    }

    return '<li class="right"> \
                <a href="#" onClick="addToWatchList(' + '\'' + loggedInAs + '\',\'' + ndc + '\', \'' + currentStatus + '\')"> \
                    <img src="/images/not_favorite.png"> \
                </a> \
           </li>';
}

function getWatchListShortageCardButtonHtml(ndc, currentStatus) {
    if (loggedInAs == "Guest") {
        return '';
    }

    return '<li class="right"> \
                <a href="#" onClick="removeFromWatchList(' + '\'' + loggedInAs + '\',\'' + ndc + '\', \'' + currentStatus + '\')"> \
                    <img src="/images/favorite.png"> \
                </a> \
            </li>';
}

function getShortageItemHTML(brand, dosage, ndc, currentStatus) {
    return '<li id="' + ndc + '"> \
                   <ul class="shortageCard"> \
                       <li class="left"> \
                           <span><a href=/DrugEntriesList/Details/' + ndc + ">" + brand + ' ' + dosage + checkBadge(ndc) + '</a></span> \
                       </li>' +
                       getNonWatchListShortageCardButtonHtml(ndc, currentStatus) +
                   '</ul> \
                </li>';
};

function getShortageItemHTMLWatchList(brand, dosage, ndc, currentStatus) {
    return '<li id="' + ndc + '"> \
                <ul class="shortageCard"> \
                    <li class="left"> \
                        <span><a href=/DrugEntriesList/Details/' + ndc + ">" + brand + ' ' + dosage + checkBadge(ndc) + '</a></span> \
                    </li>' +
                    getWatchListShortageCardButtonHtml(ndc, currentStatus) +
                '</ul> \
            </li>';
};

function checkBadge(ndc) {
    var returnedHTML = "";
    var match = false;

    var foundNdcUserVisitIndex = -1;
    var foundNdcInLastPostIndex = -1

    if (userType == "pharmadmin") {
        // Find last date of drug visit
        /*for (var i = 0; i < lastPosts.length; i++) {
            if (lastPosts[i][0] == ndc) {
                foundNdcInLastPost = true;
                foundNdcInLastPostIndex = i;

                for (var j = 0; j < lastVisits.length; j++) {
                    if (lastPosts[i][0] == lastVisits[j][0]) {
                        match = true;
                        console.log("VISIT FOUND FOR " + ndc);
                        if (lastPosts[i][1] > lastVisits[j][1]) {
                            returnedHTML = '<img src="/Images/message_badge.png">';
                        }
                    }
                }
            }
        }*/

           
            for (var i = 0; i < lastPosts.length; i++) {
                if (lastPosts[i][0] == ndc) {
                    //console.log(lastPosts[i][0])
                    foundNdcInLastPostIndex = i;
                    break;
                }
            }
            //console.log(ndc + " NOT FOUND");

            for (var i = 0; i < lastVisits.length; i++) {
                if (lastVisits[i][0] == ndc) {
                    foundNdcUserVisitIndex = i;
                    break;
                }
            }
        
            if (foundNdcInLastPostIndex > -1) { 
                if (foundNdcUserVisitIndex < 0 || lastPosts[foundNdcInLastPostIndex][1] > lastVisits[foundNdcUserVisitIndex][1]) {
                        return '<img src="/Images/message_badge.png">';
                }
            
            }
            
        }
    
    return returnedHTML;
}

function addToWatchList(username, ndc, currentStatus) {
    $.ajax({
        url: '/api/WatchListItem/' + username + "/" + ndc,
        type: 'POST',
        success: function () {
            if ($("#" + ndc).length > 0) {
                $("#" + ndc).prependTo("#" + currentStatus + "WatchList");
                $("#" + ndc + " .right").replaceWith(getWatchListShortageCardButtonHtml(ndc, currentStatus));
            }
            if ($("#recentList #" + ndc).length > 0) {
                $("#recentList #" + ndc + " .right").replaceWith(getWatchListShortageCardButtonHtml(ndc, currentStatus));
            }
        }
    });
};

function removeFromWatchList(username, ndc, currentStatus) {
    $.ajax({
        url: '/api/WatchListItem/' + username + "/" + ndc,
        type: 'DELETE',
        success: function () {
            if ($("#" + ndc).length > 0) {
                $("#" + ndc).prependTo("#" + currentStatus + "List");
                $("#" + ndc + " .right").replaceWith(getNonWatchListShortageCardButtonHtml(ndc, currentStatus));
            }
            if ($("#recentList #" + ndc).length > 0) {
                $("#recentList #" + ndc + " .right").replaceWith(getNonWatchListShortageCardButtonHtml(ndc, currentStatus));
            }
        },
    });
}

    // Filtering. Iterates over each of the 6 drug card containers (if you want to call them that?)
    // hides all elements which don't match the searchbar text. Shows all that do.
$("#searchbar").keyup(function () {
    var query = $("#searchbar").val();
    var drugListSelectors = ["#recentList", "#severeWatchList", "#warningWatchList", "#goodWatchList", "#severeList", "#warningList", "#goodList"];

    $(drugListSelectors).each( function(index, value) {
        $(value + " > li").each(function () {
            if ($(this).text().search(query) > -1) {
                $(this).show();
            }
            else {
                $(this).hide();
            }
        });
    });
});

</script>
}